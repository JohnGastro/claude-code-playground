name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest

    # ğŸ”‘ ã“ã“ã‚’æ‹¡å¼µã™ã‚‹ã“ã¨ã§OIDCã¨GitHub APIã®ä¸¡æ–¹ã«å¿…è¦ãªæ¨©é™ã‚’æ¸¡ã™
    permissions:
      contents: write        # PRã®å†…å®¹ã‚’ClaudeãŒèª­ã‚€ï¼†æ›¸ã
      pull-requests: write   # PRãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ã™ã‚‹ãŸã‚ã«å¿…è¦
      issues: write          # issueã‚³ãƒ¡ãƒ³ãƒˆæ›¸ããŸã‚ã«å¿…è¦
      id-token: write        # OIDCãƒˆãƒ¼ã‚¯ãƒ³ã‚’ClaudeãŒå–å¾—ã™ã‚‹ãŸã‚ã«å¿…è¦
      actions: read          # CIçµæœã‚’èª­ã‚€ç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          # âœ… Claude OAuthãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ`claude setup-token` ã§å–å¾—ã—ãŸsk-ã§å§‹ã¾ã‚‹ã‚‚ã®ï¼‰
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # âœ… GitHub APIã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ˜ç¤ºçš„ã«æ¸¡ã™
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # ã“ã‚Œã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå¿…è¦ãªã‚‰ï¼‰
          additional_permissions: |
            actions: read

          # Optional: ãƒ¢ãƒ‡ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
          # model: "claude-opus-4-20250514"

          # Optional: ãƒˆãƒªã‚¬ãƒ¼ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å¤‰æ›´
          # trigger_phrase: "/claude"

          # Optional: æŒ‡å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚µã‚¤ãƒ³ã•ã‚ŒãŸã‚‰ãƒˆãƒªã‚¬ãƒ¼
          # assignee_trigger: "claude-bot"

          # Optional: è¨±å¯ã™ã‚‹ãƒ„ãƒ¼ãƒ«
          # allowed_tools: "Bash(npm install),Bash(npm run build),Bash(npm run test:*),Bash(npm run lint:*)"

          # Optional: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®æŒ‡ç¤º
          # custom_instructions: |
          #   Follow our coding standards
          #   Ensure all new code has tests
          #   Use TypeScript for new files

          # Optional: ç’°å¢ƒå¤‰æ•°
          # claude_env: |
          #   NODE_ENV: test
